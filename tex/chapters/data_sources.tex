\chapter{Fuentes de datos}\label{ch:fuentes-de-datos}
% TODO: decidir si es un título adecuado, he usado uno genérico

En este capítulo se describen las fuentes de datos utilizadas en el análisis del impacto de la contaminación
atmosférica en los casos de asma en California.

Se detallan las características de cada conjunto de datos, su origen, y cómo se integran en el estudio.
En este estudio se han empleado principalmente dos fuentes de datos:
\begin{itemize}
    \item Datos de calidad del aire obtenidos de la iniciativa~\openaq.
    \item
        Datos de prevalencia de asma en la población californiana proporcionados por \datagov, la plataforma de datos
        abiertos del gobierno de Estados Unidos.
\end{itemize}

Para la extracción y filtrado de los datos, se han realizado una serie de tareas que se describirán en detalle en las
secciones siguientes.

Todo este proceso ha sido recogido en un cuaderno de Jupyter, que se puede localizar en el repositorio del proyecto,
en la ruta \texttt{code/ETL Source I.ipynb}.

\bigskip

A lo largo de las secciones, se facilitarán algunas capturas de pantalla de fragmentos del cuaderno para ilustrar
ciertas partes del proceso.

\section{Datos de calidad del aire}\label{sec:datos-de-calidad-del-aire}

Los datos de calidad del aire se han obtenido de la iniciativa~\openaq, que proporciona acceso abierto a
mediciones de contaminantes atmosféricos a nivel global.

\smallskip

Entre otros contaminantes, las entidades colaboradoras exponen datos sobre niveles de dióxido de nitrógeno ($NO_{2}$),
ozono ($O_{3}$) y material particulado fino ($PM_{2.5}$), que son relevantes para el estudio del asma.

\smallskip

Además de ofrecer un visor web, \openaq cuenta con una API que permite la descarga programática de datos históricos
y en tiempo real.
En la documentación oficial de la API se detallan los \textit{endpoints} disponibles, los parámetros de consulta y los
formatos de respuesta.

\smallskip

En concreto, es de particular relevancia el hecho de que la API tiene un límite de peticiones para distintas franjas
temporales.
En el caso de California, ha sido de relevancia considerar los siguientes límites, cuyas razones revelaremos más adelante:

\begin{itemize}
    \item 60 peticiones por minuto.
    \item 2000 peticiones por hora.
\end{itemize}

Estas restricciones han sido el principal cuello de botella a la hora de descargar grandes volúmenes de datos
históricos.

\subsection{Geografía de California}\label{subsec:geografia-california}

Los datos expuestos por el gobierno de Estados Unidos están desglosados por condados, que son las subdivisiones
administrativas de primer nivel dentro de los estados.

\bigskip

Esto es de relevancia, puesto que las estaciones de medición de calidad del aire exponen su ubicación geográfica en
coordenadas de latitud y longitud (EPSG:4326), por lo que es necesario asignar cada estación a su condado
correspondiente.

Para este cometido, se han realizado dos tareas principales:

\begin{itemize}
    \item
        \textbf{Obtener los límites geográficos de los condados de California.}
        
        Para ello, se han empleado los datos de \textit{shapefiles} proporcionados por el
        \textit{U.S. Census Bureau}~\cite{census_tiger2025_us_county}.
        Estos archivos contienen la geometría de los condados, que se ha utilizado para determinar si una estación
        de medición se encuentra dentro de un condado específico.
        
    \item
        \textbf{Filtrar las estaciones de medición mediante un \bboxt}

        (\textit{bounding box}, i.e., un rectángulo delimitador) que englobe toda California, puesto que la API de
        \openaq permite filtrar por este criterio.
\end{itemize}

\begin{comment}
    - Describir el formato de los shapefiles
    - Indicar que California se corresponde con el estado con código FIPS 06
    - Indicar que se ha empleado `shapely` para determinar si un punto está dentro de un polígono
    - Mostrar una distribución de estaciones por condado → mejor lo movemos más adelante
\end{comment}

A continuación se muestra el código empleado para descargar los shapefiles de los condados:

\begin{minted}{python}

import requests
from pathlib import Path
# download county shapefiles from US Census Bureau
shapes_url = 'https://www2.census.gov/geo/tiger/TIGER2025/COUNTY/tl_2025_us_county.zip'
geo_dir = Path("data/geographical")
geo_dir.mkdir(parents=True, exist_ok=True)
shapes_path = geo_dir / "tl_2025_us_county.zip"
if not shapes_path.exists():
    print(f"Downloading county shapefiles from {shapes_url}...")
    r = requests.get(shapes_url)
    with open(shapes_path, 'wb') as f:
        f.write(r.content)
    print(f"Downloaded to {shapes_path}")
else:
    print(f"Shapefiles already exist at {shapes_path}")
   
\end{minted}

El archivo comprimido descargado se encuentra en la ruta \path{data/geographical/tl_2025_us_county.zip},
cuya versión descomprimida se halla en la sub-carpeta \path{california_counties}; en caso de que el lector desee
explorar los archivos.

\bigskip

En la Figura~\ref{fig:us_counties_qgis} se muestra una captura de pantalla de los condados de Estados Unidos
visualizados en QGIS, un software de sistemas de información geográfica (\textit{GIS}).

Los condados de California están resaltados en rosa.

\bigskip

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\linewidth]{figures/us_counties_qgis}
    \caption{Visualización de condados en QGIS}
    \label{fig:us_counties_qgis}
\end{figure}

Son de particular interés las siguientes columnas:

\begin{itemize}
    \item \texttt{STATEFP}: código FIPS del estado (California es 06).
    
    \item \texttt{NAME}: nombre del condado, valor que empleamos para relacionarlo con los datos de asma.
    
    \item
        \texttt{geometry}: geometría del condado en formato poligonal, es decir, una cadena de texto en formato WKT
        (\textit{Well-Known Text}).
    
        Se facilita un ejemplo ilustrativo en la Figura~\ref{fig:wkt-ejemplo}.
   
\end{itemize}

\begin{figure}[ht]
    \centering
    \begin{minted}[fontsize=\small,frame=single]{text}
        POLYGON ((-122.373121 37.883884, -122.371142 37.884364, ... ))
    \end{minted}
    \caption{Ejemplo: geometría en WKT (ilustrativo)}
    \label{fig:wkt-ejemplo}
\end{figure}

Para procesar estos datos geográficos, se ha empleado la librería
\mintinline{python}{geopandas}, que extiende las funcionalidades de \mintinline{python}{pandas} para manejar
datos espaciales.

En concreto, nos permite usar el método \mintinline{python}{Polygon.contains()} para determinar si las coordenadas
de una estación de medición están dentro de la geometría de un condado.

\bigskip

Una vez que tenemos definido el flujo a seguir para clasificar las estaciones por condado, procedemos a exponer la
cuestión de decidir cómo filtrar las estaciones de interés a través de la API de \openaq.

Como ya se ha mencionado, la API permite filtrar las estaciones mediante un \textit{bounding box}, que se define
por las coordenadas de sus esquinas suroeste y noreste.

Para California, simplemente se ha usado QGIS para obtener unas coordenadas aproximadas que engloban todo el estado.
En la Figura~\ref{fig:california_bbox_qgis} se muestra una captura de pantalla de QGIS donde se procede a copiar las
coordenadas.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{figures/california_bbox_qgis}
    \caption{Obtención del \bboxt de California en QGIS}
    \label{fig:california_bbox_qgis}
\end{figure}

Se puede consultar el código empleado en la Sección~\ref{sec:extraccion-de-datos-de-openaq}.

Posteriormente, estos datos se han procesado para asignar cada estación a su condado correspondiente, como se ha
descrito anteriormente.

Se proporciona una tabla con la distribución de estaciones por condado en California (se ha mostrado solo
los 10 primeros condados ordenados por recuento) en la Tabla~\ref{tab:county_counts}.

\begin{table}[ht]
    \centering
    \caption{Recuento por condado}
    \label{tab:county_counts}
    \begin{tabular}{lr}
        \toprule
        Condado & Recuento \\
        \midrule
        Los Angeles      & 403 \\
        Alameda          & 190 \\
        Mono             &  94 \\
        Contra Costa     &  87 \\
        Sacramento       &  83 \\
        San Francisco    &  66 \\
        Monterey         &  50 \\
        Sonoma           &  48 \\
        San Diego        &  46 \\
        San Luis Obispo  &  44 \\
        \bottomrule
    \end{tabular}
\end{table}


\subsection{Descarga de datos históricos}\label{subsec:descarga-datos-historicos}

\begin{comment}
    - Explicar la cabecera `X-Rate-Limit-Remaining` y cómo se ha empleado para gestionar las peticiones
    - Explicar el tiempo estimado para descargar los datos de toda California
    - Explicar que el código se tuvo que modificar varias veces, pero no se perdió el progreso gracias a los archivos
      intermedios, por eso la barra de progreso muestra un tiempo menor del real
    - Explicar que son 5333 archivos JSON, por lo que se ha optado comprimirlos en un ZIP para facilitar su manipulación
    - Mostrar como ejemplo la estructura de una respuesta en formato JSON
\end{comment}

Ahora que tenemos los datos de las estaciones de interés, el siguiente paso es realizar una petición a la API
de \openaq para descargar los datos históricos de calidad del aire.

La documentación oficial de la API se puede consultar en la fuente~\cite{openaq_api_docs}.

La API devuelve información sobre los sensores de cada estación, que miden distintos contaminantes atmosféricos.

A partir de esto, se ha diseñado un bucle que itera sobre los 5333 sensores identificados en California, empleando el
\textit{endpoint} \texttt{/sensors} de la API.

Dado que la API impone límites en el número de peticiones por minuto y por hora, se ha implementado una lógica
para monitorizar las cabeceras de respuesta \texttt{X-Rate-Limit-Remaining} y pausar las peticiones cuando sea necesario.

Este proceso ha tenido una naturaleza iterativa en cuanto al código, puesto que han surgido varios inconvenientes
durante la descarga masiva de datos.

Sin embargo, puesto que se han guardado los datos descargados en archivos intermedios, no se ha perdido el progreso
realizado hasta el momento.

Es por esta razón que la barra de progreso muestra un tiempo estimado menor del real.

Teniendo en cuenta los límites impuestos por la API, se estima que la descarga completa de los datos históricos
de calidad del aire en California lleva entre 2 y 3 horas.

Se adjunta una captura de pantalla en la Figura~\ref{fig:openaq_download_progress} que ilustra el progreso de la descarga.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{figures/openaq_download_progress}
    \caption{Celda del cuaderno ilustrando las peticiones}
    \label{fig:openaq_download_progress}
\end{figure}

Puesto que se han guardado los datos descargados en archivos JSON individuales, se ha optado por comprimirlos en un archivo ZIP
para facilitar su manipulación posterior.

Además, puesto que no se van a modificar, facilita su almacenamiento y distribución.

El bucle se puede consultar en el cuaderno de Jupyter.
No lo incluimos aquí por su extensión.

En la Figura ~\ref{fig:openaq_sample_json} se muestra un ejemplo de la estructura de una respuesta en formato JSON, cuyo
contenido ha sido truncado para mayor claridad.

\begin{figure}[H]
    \centering
    \begin{minted}[fontsize=\small,frame=single]{json}
[
    {
        "value": 9.0,
        "flagInfo": {
            "hasFlags": false
        },
        "parameter": {
            "id": 2,
            "name": "pm25",
            "units": "\u00b5g/m\u00b3",
            "displayName": null
        },
        "period": {
            "label": "raw",
            "interval": "01:00:00",
            "datetimeFrom": {
                "utc": "2016-03-06T19:00:00Z",
                "local": "2016-03-06T11:00:00-08:00"
            },
            "datetimeTo": {
                "utc": "2016-03-06T20:00:00Z",
                "local": "2016-03-06T12:00:00-08:00"
            }
        },
        ...
    }
]
    \end{minted}
    \caption{Ejemplo de respuesta JSON de la API de \openaq}
    \label{fig:openaq_sample_json}
\end{figure}


\subsection{Procesamiento de los datos descargados}\label{subsec:procesamiento-datos-descargados}

\begin{comment}
    - Explicar que se ha creado una base de datos SQLite para facilitar el análisis posterior
    - Mostrar un esquema de la base de datos
    - REMINDER: los datos no han sido curados, solo se han insertado tal cual
    - Explicar, si procede, las decisiones de diseño tomadas (tipos de datos, índices, etc.)
\end{comment}

Con la idea de integrar los datos de calidad del aire con los datos de asma, se ha creado una base de datos SQLite
para facilitar el análisis posterior.

Se ha diseñado un esquema de base de datos que incluye tablas para las estaciones de medición, los sensores, las mediciones
realizadas … entre otros.

El esquema de las tablas se puede consultar en la Sección~\ref{sec:schema-de-primera-fuente-de-datos}.

En la Figura~\ref{fig:database_schema} se muestra un esquema generado por DBeaver de la base de datos.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{../data/openaq_data/sensors/aq_data_cal}
    \caption{Esquema de la BD en la Fase I}
    \label{fig:database_schema}
\end{figure}

Más adelante, la base de datos se ampliará para incluir los datos de asma, permitiendo realizar consultas
complejas que relacionen ambos conjuntos de datos.

\subsection*{Descripción del esquema de la base de datos}

El esquema modela un sistema de \textbf{monitoreo ambiental} basado en estaciones y sensores, donde se registran mediciones de contaminantes a lo largo del tiempo.
La estructura se compone de seis tablas principales y varias relaciones mediante claves foráneas.

\begin{itemize}
  \item \textbf{units}: almacena las \textbf{unidades de medida} usadas en las mediciones (por ejemplo, \textit{$\mu g/m^3$}, \textit{ppm}).
  Contiene un identificador (\texttt{unit\_id}), el nombre de la unidad (\texttt{unit\_name}) y una descripción opcional (\texttt{description}).

  \item \textbf{pollutants}: catálogo de \textbf{contaminantes} medidos (por ejemplo, \textit{NO\textsubscript{2}}, \textit{PM2.5}, \textit{O\textsubscript{3}}).
  Incluye \texttt{pollutant\_id} y \texttt{pollutant\_name}.

  \item \textbf{counties}: representa las \textbf{entidades geográficas} (condados).
  Guarda \texttt{county\_id}, el nombre (\texttt{county\_name}) y un campo \texttt{geometry} para almacenar la geometría (típicamente en formato texto, p.\ ej.\ WKT/GeoJSON).

  \item \textbf{stations}: define las \textbf{estaciones de monitoreo} asociadas a un condado.
  Cada estación (\texttt{station\_id}) puede tener un \texttt{county\_id} (clave foránea a \texttt{counties}) y coordenadas geográficas (\texttt{latitude}, \texttt{longitude}).

  \item \textbf{sensors}: modela los \textbf{sensores instalados en estaciones}.
  Un sensor (\texttt{sensor\_id}) pertenece a una estación (\texttt{station\_id}) y está asociado a un contaminante (\texttt{pollutant\_id}) y a una unidad de medida (\texttt{unit\_id}).
  Estas relaciones se implementan con claves foráneas hacia \texttt{stations}, \texttt{pollutants} y \texttt{units}.

  \item \textbf{measurements}: almacena las \textbf{mediciones} generadas por cada sensor.
  
  Incluye \texttt{measurement\_id}, el sensor (\texttt{sensor\_id}), el valor medido (\texttt{measurement\_value}) y el intervalo temporal de validez (\texttt{start\_time}, \texttt{end\_time}).
  Además, se define una restricción \texttt{UNIQUE(sensor\_id, start\_time, end\_time)} para evitar duplicados del mismo sensor en el mismo intervalo.
\end{itemize}

\subsubsection*{Relaciones principales}

\begin{itemize}
  \item Un \textbf{condado} (\texttt{counties}) puede tener muchas \textbf{estaciones} (\texttt{stations}).
  Esto se define con \texttt{stations.county\_id} $\rightarrow$ \texttt{counties.county\_id}.

  \item Una \textbf{estación} puede tener muchos \textbf{sensores}.
  Esto se define con \texttt{sensors.station\_id} $\rightarrow$ \texttt{stations.station\_id}.

  \item Un \textbf{sensor} mide un \textbf{contaminante} y usa una \textbf{unidad}.
  
  Esto se define con \texttt{sensors.pollutant\_id} $\rightarrow$ \texttt{pollutants.pollutant\_id} y \texttt{sensors.unit\_id} $\rightarrow$ \texttt{units.unit\_id}.

  \item Un \textbf{sensor} genera muchas \textbf{mediciones}.
  Esto se define con \texttt{measurements.sensor\_id} $\rightarrow$ \texttt{sensors.sensor\_id}.
\end{itemize}



\newpage

\section{Datos de prevalencia de asma en California}\label{sec:datos-asma}

\begin{comment}
    - Explicar la estructura de los datos obtenidos de data.gov
    - TODO: procesar los datos en la base de datos SQLite
    - Mostrar un esquema actualizado de la base de datos
    - Explicar las decisiones de diseño tomadas (tipos de datos, índices, etc.)
\end{comment}

Los datos de prevalencia de asma en California se han obtenido de \datagov, la plataforma de datos abiertos del
gobierno de Estados Unidos~\cite{cdph_asthma_prevalence_datagov}.

La iniciativa CHIS (California Health Interview Survey) proporciona datos detallados sobre la salud de la
población californiana, incluyendo información sobre la prevalencia de asma.

Estos datos describen la proporción de personas diagnosticadas con asma en distintos condados de California,
desglosados por año, grupo de edad, género y otros factores demográficos.

La extensión temporal de los datos abarca desde 2015 hasta 2021 (hasta el final de año), lo que permite analizar
tendencias a lo largo del tiempo, si bien de forma limitada.

\bigskip

Debido a la urgencia de disponer de estos datos para el análisis, se ha optado por realizar este análisis con
una cantidad limitada de años.

En futuras iteraciones del proyecto, se podría ampliar el rango temporal para obtener una visión más completa
de la evolución de la prevalencia de asma en California.

Es por esto que se ha optado emplear una base de datos SQLite para integrar estos datos con los de calidad del aire.
Permitiendo un mayor grado de extensibilidad y flexibilidad en el análisis posterior.

\bigskip

Similarmente a la fase anterior, se puede consultar el esquema actualizado de la base de datos en la Sección~\ref{sec:schema-de-segunda-fuente-de-datos}.

El diagrama generado por DBeaver se muestra en la Figura~\ref{fig:database_schema_updated}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{../data/openaq_data/sensors/unified phase 2}
    \caption{Esquema tras implementar la segunda fuente}
    \label{fig:database_schema_updated}
\end{figure}

\subsection*{Descripción del esquema actualizado de la base de datos}

Este esquema modela un conjunto de datos de \textbf{prevalencia de asma} por condado y por \textbf{gropo demográfico},
incluyendo intervalos de confianza.

Cabe mencionar que algunos condados pueden agruparse en ciertas observaciones, lo que se gestiona mediante una tabla intermedia.

\bigskip

La tabla principal es \textbf{\texttt{asthma\_prevalence}}.

Cada fila representa una observación de prevalencia asociada a un \textbf{condado} (\texttt{county\_id}) y a un \textbf{periodo temporal} definido por \texttt{year\_from} y \texttt{year\_to}.

La prevalencia se almacena en \texttt{current\_prevalence}, y la incertidumbre se captura con el intervalo de confianza del 95\% mediante \texttt{ci\_95\_lower} y \texttt{ci\_95\_upper}.

El campo \texttt{comment} permite registrar notas o aclaraciones del dato (agrupaciones, incertidumbres\ldots).

Además, la observación se vincula a una definición de subpoblación mediante \texttt{demographic\_group\_id}, y se mantiene integridad referencial con claves foráneas hacia \texttt{counties(county\_id)} y \texttt{demographic\_group(id)}.

\bigskip

La tabla \textbf{\texttt{demographic\_group}} define los \textbf{grupos demográficos/poblacionales} empleados en el dataset.

El campo \texttt{strata} identifica la \textbf{subpoblación} al que corresponde el registro (por ejemplo,
\textit{All ages}, \textit{Age groups} o \textit{Child vs. Adult}).

El campo \texttt{age\_group} conserva la etiqueta de edad exactamente como aparece en los datos originales.

Para facilitar análisis cuantitativos, \texttt{age\_min} y \texttt{age\_max} almacenan, cuando es posible, una normalización numérica del rango de edad.
De esta forma es posible filtrar por intervalos (p.\ ej.\ 0--4, 5--17, 18--64, etc.) incluso si la etiqueta original es textual.

\bigskip

La tabla \textbf{\texttt{grouped\_counties}} representa los casos en los que una observación del dataset corresponde a un \textbf{grupo de condados} (columna \texttt{COUNTIES GROUPED}).

Cada fila enlaza un \texttt{county\_id} con un \texttt{asthma\_prevalence\_id}, permitiendo reconstruir exactamente qué condados están incluidos en esa agregación.

La clave primaria compuesta \texttt{(county\_id, asthma\_prevalence\_id)} evita duplicidades y mantiene la consistencia de la relación.

En conjunto, el esquema separa la \textbf{medición} (prevalencia e intervalos) de las dimensiones \textbf{geográfica} (condados) y \textbf{poblacional} (estratos y edades).
Esto permite consultas flexibles tanto para registros por condado individual como para resultados agregados por grupos de condados.

\newpage
\section{Limitaciones de las fuentes de datos}\label{sec:limitaciones-fuentes-datos}

\begin{comment}
    - Explicar que ni Modoc ni Sierra tienen estaciones de medición
    - Explicar que algunas estaciones/sensores han dejado de estar operativos
    - Explicar que el período temporal no es muy extenso, si bien se puede ampliar en el futuro
\end{comment}